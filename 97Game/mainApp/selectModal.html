<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>
    <!-- Bootstrap -->
    <link href="../node_modules/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../style.css">
    <script src="../encode.js"></script>
    <style>
    .jumbotron {background-color:#000;}
    .fontSizeC {color:#fff;}
    .selectRole-mainRole{height:250px;}
    .thumbnail{border:none;}
    </style>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body class="selectModal-body">
    <!-- 我的个人新信息 -->
    <div class="modal fade bs-example-modal-sm" tabindex="-1" id="show_userMessage" role="dialog" aria-labelledby="mySmallModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content" >
          <div class="container">
            <img src="../images/other/usermessage.jpg" alt="" style="margin:0 auto;position:relative;left:30px;">
            <h3>个人信息</h3>
            <h5>账户名称：<span id="sql_name"></span></h5>
            <h5>账户余额：<span id="sql_acount"></span></h5>
            <h5>队伍体力：<span id="sql_power"></span></h5>
            <h5>队伍数量：<span id="sql_Team"></span></h5>
            <h5>队伍战力：<span id="sql_combat"></span></h5>
            <h5>VIP 等级：<span id="sql_title"></span></h5>
          </div>
        </div>
      </div>
    </div>

    <!-- 我的队伍 -->
    <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" id="show_userTeam" aria-labelledby="myLargeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content"  style="text-align: center;">
          <div class="row" id="all_userTeam">
            
          </div>
        </div>
      </div>
    </div>

    <!-- 游戏帮助 -->
    <div class="modal fade bs-example-modal-lg" tabindex="-1" id="show_book" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content" style="text-align: center;">
          <div class="row" id="sql_book" style="text-align: center;">
            <div class='col-sm-12 col-md-12' style='margin-top:20px'>
              <h3>拳皇97 合卡游戏玩法介绍</h3>
              <div style='text-align: left;padding-left: 100px;' class='query_help'>
                <p><1>首次登陆游戏可以获得888金币和100体力值，您可以用来购买对应价格的人物</p>       
                <p><2>游戏目前只支持三种方式获得碎片</p>
                <p style='margin-left: 20px;'><2.1>进入战斗选择“经典模式”可以进行与玩家对战获得出站人物的碎片</p>       
                <p style='margin-left: 20px;'><2.2>进入战斗选择“战斗模式”可以进行与玩家对战获得出站人物的碎片</p>       
                <p style='margin-left: 20px;'><2.3>可以选择进入抽奖页面进行抽奖或得人物碎片</p>       
                <p><3>拥有人物碎片后可以进行强化！来提高当前人物的属性</p>       
                <p><4>如果发现主页面商城中的人物角色太少不防试试“神秘商店”这里有你想要的</p>       
                <p><5>如果想要查看当前的人物属性或者其他的信息可以点击左边的导航进行查询</p>       
                <p><6>“战斗模式”中不仅可以得到相应的人物碎片还可以获得一定数量的金币</p>       
                <p><7>游戏中目前“修炼模式”还未开启，敬请期待下次的版本更新</p>       
                <p><8>祝大家玩得愉快！欢迎大家提出宝贵的意见和建议！微信：1305226892 </p>       
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="mainRole" class="selectRole-mainRole">
      <span class="glyphicon glyphicon-user" id="P_message" data-toggle="tooltip" data-placement="right" title="我的信息">
      </span>
      <span class="glyphicon glyphicon-flag" id="P_team" data-toggle="tooltip" data-placement="right" title="我的队伍">
      </span>

      <span class="glyphicon glyphicon-arrow-left" onclick="javascript:history.back();" id="P_left" data-toggle="tooltip" data-placement="right" title="返回上级">
      </span>

      <span class="glyphicon glyphicon-refresh" id="P_refresh" data-toggle="tooltip" data-placement="right" title="刷新页面">
      </span>
      <span class="glyphicon glyphicon-book" id="P_book" data-toggle="tooltip" data-placement="right" title="查看帮助">
      </span>
    </div>

    <div>
      <div class="jumbotron battle-message" >
        <div class="container" id="all_battleMessage">
          
        </div>
      </div>
    </div>
    <div class="container ModeContainer">
      <!-- 我的队伍 -->
      <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" id="show_userTeam" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content" id="all_userTeam" style="text-align: center;"></div>
        </div>
      </div>
      <!-- 经典模式的战斗 -->
      <div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" id="show_battle" aria-labelledby="myLargeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content" id="all_battle" style="text-align: center;">
            <table class="select-battle">
              
            </table>
          </div>
        </div>
      </div>
      <!-- 经典模式的战斗信息 -->
      <div id="battle_message" class="battle-message">

      </div>
      <!-- <img src="../images/other/selector.jpg" alt="" id="bg-image"> -->
      <div class="container selectModal-container">
        <img src="../images/other/jindian01.jpg" alt="" id="jinDian_Modal" class="selectModal-role">
        <img src="../images/other/zhandou01.jpg" alt="" id="zhanDou_Modal">
        <img src="../images/other/xiulian01.jpg" alt="" id="xiuLian_Modal">
      </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="http://cdn.bootcss.com/jquery/1.11.1/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script>
      var user_location=window.location.search;
      var uName=hexToDec(user_location.substring(user_location.indexOf("_")+1));
      var data={"uName":uName};
      var challgerCarId=[];
      $(document).ready(function(){
        $.ajax({
          type:"POST",
          data:data,
          url:"testUser.php",
          success:function(e){

            if(e=="error"){
              alert("迷之操作！！！请重新登录");
              window.location.href="http://localhost/QHgame/97Game";
            }
          },
          error:function(e){
            alert("迷之操作！！！请重新登录");
            window.location.href="http://localhost/QHgame/97Game";
          }
        })
      })
      $("#bg-image").css("height",innerHeight+"px")
      $("#bg-image").css("width",innerWidth+"px")

      //点击进入经典模式
      $("#jinDian_Modal").on("click",function(){
        $.ajax({
          type:"POST",
          data:data,
          url:"sqlUserMessage.php",
          success:function(e){
            var ReceivedData=JSON.parse(e);
            if(ReceivedData.carid==null/*||ReceivedData.user_power<=0*/){
              alert("您当前还未添加任何人物拥有！请先购买人物");
              return;
            }
            var ConditionCar=ReceivedData.carid.length;
            var ConditionPower=Number(ReceivedData.user_power);
            if(/*ConditionCar>=6&&ConditionPower>0*/true){
              //进入经典模式展示个人队伍
              $("#show_userTeam").modal();
              var str='';
              if(uName!=''){
                $.ajax({
                  type:"POST",
                  data:data,
                  url :"selectRole.php",
                  success:function(e){
                    var carId=JSON.parse(e);
                    var allId=carId.carid.split(",");
                    if(allId!=null){
                      for(var i=0;i<allId.length;i++){
                        if(i!=0){
                          str+="<div style='display:inline-block;position:relative;' id='RoleSelected_active'>"+
                          "<img style='margin:20px;' src='../images/showRole/"+allId[i]+".png' id="+allId[i]+">"+
                          "<img src='../images/other/selected.png' class='RoleSelected' />"+
                          "</div>"
                        }
                      }
                      $("#all_userTeam").html(
                        "<h3 style='font-weight: bold;'>请选择出战人物</h3>"+str+
                        "<div style='margin:20px;'><button class='btn btn-primary' id='SelectedOver'>完成</button><div>"
                        )
                    }
                    $("#RoleSelected_active>img").on("click",function(){
                      $(this).next().toggleClass("RoleSelected-active")
                    })
                    $("#SelectedOver").on("click",function(){
                      SelectedLess3();
                    })
                  },
                  error:function(){
                    alert("查询失败！请重新查询")
                  }
                })
              }else{
                alert("登录跳转失败！请重新登录")
                window.location.href="http://localhost/QHgame/97Game";
              }  
            }else{
              alert("出错请重新尝试！")
            }
            
          },
          error:function(e){
            alert("选择失败！请重新选择")
          }
        })
      })
      function SelectedLess3(){
        if($(".RoleSelected-active").length>0){
          var allSelected=$(".RoleSelected-active").prev("img");
          var selectedArr=[];
          for(var i=0;i<allSelected.length;i++){
            selectedArr.push(allSelected[i].id);
          }
          var data={"uName":uName,"carId":selectedArr}
          $.ajax({
            type:"POST",
            data:data,
            url :"selectedTojinDian.php",
            success:function(e){
              var receiveData=JSON.parse(e);
              if(receiveData.hasRole){
                challgerCarId=selectedArr;
                $('#show_userTeam').modal('hide');
                BattleTeam();
              }else{
                alert("操作失败！请重新选择")
              }
            },
            error:function(){
              alert("选择失败！请重新选择")
            }
          })
        }else{
          alert("选择失败！请重新选择")
        }
      }
      function BattleTeam(){
        $.ajax({
            type:"POST",
            data:'',
            url :"showBattle.php",
            success:function(e){
              var receiveData=JSON.parse(e);
              var str='<tr><th>排名</th><th>玩家</th><th>战力</th><th></th></tr>';
              for(var i=receiveData.length,order=0;i>0;i--){
                if(receiveData[i-1].user_name==uName&&receiveData[i-1].carid!=null/*&&receiveData[i-1].carid.length>=5*/){
                  str+="<tr>"+
                      "<td>"+(++order)+"</td><td>"+receiveData[i-1].user_name+"</td><td>"+receiveData[i-1].user_combat+
                      "</td><td></td>"+
                       "</tr>"
                }else if(receiveData[i-1].carid!=null/*&&receiveData[i-1].carid.length>=5*/){
                  str+="<tr>"+
                      "<td>"+(++order)+"</td><td class='changeName'>"+receiveData[i-1].user_name+"</td>"+
                      "<td>"+receiveData[i-1].user_combat+
                      "</td><td><a class='btn btn-primary'>发起挑战</a></td>"+
                       "</tr>"
                }else{
                  continue;
                }
              }
              $('#show_battle').modal();
              $("#all_battle>table").html(str);
              $(".select-battle td>a").on("click",function(){
                ClickBattle.bind(this)();
              })
            },
            error:function(){
              alert("选择失败！请重新选择")
            }
        })
      }
      function ClickBattle(){
        var changeOBJ=$(this).parents("td").siblings(".changeName").html();
        var data={"uName":uName,"changeOBJ":changeOBJ};
        var challenger={};
        var beChallenger={};
        var isdefeated=true;
        $.ajax({
          type:"POST",
          data:data,
          url :"startBattle.php",
          success:function(e){
            $('.ModeContainer').css("display",'none');
            var str='<h1 style="text-align:center;color:#fff;">战斗开始</h1>*';
            var receiveData=JSON.parse(e);
            debugger;
            challgerCarId;
            for(var key in receiveData){
              switch (key){
                case "challenger" : 
                challenger=receiveData[key];
                break;
                case "bechallenger" : 
                beChallenger=receiveData[key];
              }
            }
            for(var i=0,k=0;i<challenger.length;i++){
              if($.inArray(challenger[i].roleid,challgerCarId)!=-1){
                if(beChallenger[k]==null){
                  isdefeated=false; 
                  str+="<h1 style='color:red;'>挑战成功！恭喜获胜</h1>*";
                  BattleVictory(challgerCarId,str);//挑战成功执行函数减体力调整排名随机获得挑战人员的碎片
                  break;
                }
                //挑战者攻击-防御
                var GGF=challenger[i].roleattack-beChallenger[k].roledefense;
                //挑战者生命值
                var GLife=challenger[i].rolelife;
                //被挑战者攻击-防御
                var FGF=beChallenger[k].roleattack-challenger[i].roledefense;
                if(FGF<0)FGF=0;
                //被挑战者生命值
                var FLife=beChallenger[k].rolelife;
                //某方人物阵亡
                while(GLife>0&&FLife>0){
                  FLife-=GGF;
                  GLife-=FGF;
                  if(FLife<0)FLife=0;
                  if(GLife<0)GLife=0;
                  str+=
                  "<span style='color:green;'>己方：</span>"+
                  "<span class='fontSizeC'>"+challenger[i].rolename+"发动攻击造成"+GGF+"点伤害,对手剩余"+FLife+"点生命值</span>"+
                  "<span style='color:red;'>敌方：</span>"+
                  "<span class='fontSizeC'>"+beChallenger[k].rolename+"发动攻击,造成"+FGF+"点伤害,你还剩"+GLife+"点生命值</span>"
                  if(FLife<=GGF){//如果被挑战者第一个人物被攻击死
                    challenger[i].rolelife=GLife;
                    beChallenger[k].rolelife=0;
                    str+="<h2 style='color:red'>敌方"+beChallenger[k].rolename+"已阵亡</h2>*";
                    i--;
                    k++;
                    break;
                  }else if(GLife<=FGF){//如果挑战者第一个人物被攻击死
                    beChallenger[k].rolelife=FLife;
                    challenger[i].rolelife=0;
                    str+="<h2 style='color:green'>已方"+challenger[i].rolename+"已阵亡</h2>*";
                    break;
                  }
                }
              }
            }
            if(isdefeated){
              str+="<h1 style='color:blue;'>挑战失败...</h1>*";
              BattleDefeated(str);//失败执行函数减体力
            };
          },
          error:function(){
            alert("出错!!!请请重新操作")
          }
        })
      }
      function BattleVictory(arr,str){
        var str=str.split("*");
        var length=str.length;
        var index=0;
        var timer;
        var chip=arr[Math.floor(Math.random()*(arr.length-0))];
        var data={"uName":uName,"rolechip":chip}
        $.ajax({
          type:"POST",
          data:data,
          url :"BattleVictory.php",
          success:function(e){
            if(e!='error'){
              $('#show_battle').modal('hide');
              $('.battle-message').css("display","block");
              var receiveData=JSON.parse(e);
              if(receiveData.randNum==0){
                  timer=setInterval(function(){
                    if(index<length-1){
                      $("#all_battleMessage").append(str[index]);
                    }else{
                      clearInterval(timer); 
                      $("#all_battleMessage").append("<div>未获得任何碎片</div><button class='btn btn-danger'"+
                      "id='close_battleMessage'>关闭</button>")                     
                    }
                    index++;
                  },1000)
                /*$("#all_battleMessage").html(str+"<div>未获得任何碎片</div><button class='btn btn-danger'"+
                "id='close_battleMessage'>关闭</button>")*/
              }else{
                  timer=setInterval(function(){
                    if(index<length-1){
                      $("#all_battleMessage").append(str[index]);
                    }else{
                      clearInterval(timer);
                      $("#all_battleMessage").append(
                      "<div>"+
                          "<h3>恭喜获得"+receiveData.randNum+"个碎片可用于合成人物，提高人物的属性噢！</h3>"+
                          "<img src='../images/showRole/"+receiveData.carid+".png'>"+
                      "</div>"+
                      "<button class='btn btn-danger'"+
                      "id='close_battleMessage' style='margin-top:30px;'>关闭</button>")                  
                    }
                    index++;
                  },1000)
                /*$("#all_battleMessage").html(str+
                  "<div>"+
                    "<h3>恭喜获得"+receiveData.randNum+"个碎片可用于合成人物，提高人物的属性噢！</h3>"+
                    "<img src='../images/showRole/"+receiveData.carid+".png'>"+
                  "</div>"+
                  "<button class='btn btn-danger'"+
                "id='close_battleMessage' style='margin-top:30px;'>关闭</button>")*/
              }
              $(".battle-message").on('click','#close_battleMessage',function(){
                $('.battle-message').fadeToggle("3000",function(){$("#all_battleMessage").html('');
                  $(".battle-message").css('display','none')});
                  $('.ModeContainer').css("display",'block')
              })
            }else{
              alert("出错!!!请请重新操作")
            }
          },
          error:function(){
            alert("出错!!!请请重新操作")
          }
        })
      }
      function BattleDefeated(str){
        var str=str.split("*");
        var length=str.length;
        var index=0;
        var timer;
        var data={"uName":uName};
        $.ajax({
          type:"POST",
          data:data,
          url :"BattleDefeated.php",
          success:function(e){
            if(e=="success"){
              $('#show_battle').modal('hide');
              $('.battle-message').css("display","block");
              timer=setInterval(function(){
                if(index<length-1){
                  $("#all_battleMessage").append(str[index]);
                }else{
                  clearInterval(timer); 
                  $("#all_battleMessage").append("<div>未获得任何碎片</div><button class='btn btn-danger'"+
                  "id='close_battleMessage'>关闭</button>")                     
                }
                index++;
              },1000)              
              /*$("#all_battleMessage").html(str+
                "<div>"+
                  "<img src='../images/other/nochip.jpg'>"+
                "</div>"+
                "<button class='btn btn-danger'"+
              "id='close_battleMessage' style='margin-top:30px;'>关闭</button>")*/
              
              $(".battle-message").on('click','#close_battleMessage',function(){
                $('.battle-message').fadeToggle("3000",function(){$("#all_battleMessage").html('');
                  $(".battle-message").css('display','none')});
                  $('.ModeContainer').css("display",'block')
              })
            }else{
              alert("出错!!!请请重新操作")
            }
          },
          error:function(e){
            alert("出错!!!请请重新操作")
          },
        })
      }
      $("#zhanDou_Modal").on("click",function(){
        window.location.href="http://localhost/QHgame/97Game/mainApp/ModalToBattle.html?UFO"+
        +Math.ceil(Math.random()*520)+'_'+decToHex(uName);
      })
      $("#xiuLian_Modal").on("click",function(){
        alert("暂未开放")
        /*window.location.href="http://localhost/QHgame/97Game/mainApp/ModalToBattle.html?UFO"+
        +Math.ceil(Math.random()*520)+'_'+decToHex(uName);*/
      })


      /*左侧导航的功能*/
      //hover左边导航进行提示的信息
      $('#P_message').tooltip();
      $('#P_team').tooltip();
      $('#P_left').tooltip();
      $('#P_refresh').tooltip();
      $('#P_book').tooltip();

      //点击导航展示详细的信息
      $("#P_message").click(function(){//个人信息
        $("#show_userMessage").modal();
        if(uName!=''){
          $.ajax({
            type:"POST",
            data:data,
            url :"sqlUserMessage.php",
            success:function(e){
              var allMessage=JSON.parse(e);
              if(allMessage.carid==null){
                $("#sql_Team").html();
              }else{
                var length=allMessage.carid.split(",").length;
                $("#sql_Team").html(parseInt(length)-1);
              }
              $("#sql_name").html(data.uName);
              $("#sql_V").html(allMessage.user_v);
              $("#sql_power").html(allMessage.user_power);
              $("#sql_acount").html(allMessage.user_money);
              $("#sql_title").html(allMessage.user_title);
              $("#sql_combat").html(allMessage.user_combat);
            },
            error:function(){
              alert("查询失败！请重新查询")
            }
          })
        }else{
          alert("登录跳转失败！请重新登录")
          window.location.href="http://localhost/QHgame/97Game";
        }  
      })

      $("#P_team").click(function(){//个人队伍
        $("#show_userTeam").modal();
        var str='';
        if(uName!=''){
          $.ajax({
            type:"POST",
            data:data,
            url :"selectRole.php",
            success:function(e){
              var carId=JSON.parse(e);
              if(carId.carid!=null){
                var allId=carId.carid.split(",");
              }else{
                $("#all_userTeam").html("<img src='../images/other/nochip01.jpg'><h3>您当前还未添加任何人物...</h3>")
                return;
              }
              
              hasCarId=allId;
              if(allId.length==1){
                $("#all_userTeam").html("<img src='../images/other/nochip01.jpg'><h3>您当前还未添加任何人物...</h3>")
                return;
              }
              if(allId!=null){
                $.ajax({
                  type:"POST",
                  data:{"uName":uName,"carId":allId},
                  url :"showCurrentRole.php",
                  success:function(e){
                    var data=JSON.parse(e);
                    var roleData;
                    for(var i=0;i<allId.length;i++){
                      if(i!=0){
                        for(var k=0;k<data.length;k++){
                          if(data[k]['roleid']==allId[i]){
                            roleData=data[k];
                            break;
                          }
                        }
                        str+="<div class='col-sm-6 col-md-4'>"+
                                "<div class='thumbnail'>"+
                                  "<img src='../images/showRole/"+allId[i]+".png'/>"+
                                  "<div class='caption' style='text-align:center;'>"+
                                    "<p>攻击力："+roleData.roleattack+"</p>"+
                                    "<p>防御力："+roleData.roledefense+"</p>"+
                                    "<p>生命值："+roleData.rolelife+"</p>"+
                                  "</div>"+
                                "</div>"+
                              "</div>"
                      }
                    }
                    $("#all_userTeam").html("<h3>我的队伍信息</h3>"+str)
                  },
                  error:function(){
                    alert("查询失败！请重新查询")
                  }
                })
                
              }
            },
            error:function(){
              alert("查询失败！请重新查询")
            }
          })
        }else{
          alert("登录跳转失败！请重新登录")
          window.location.href="http://localhost/QHgame/97Game";
        }  
      })

      $('#P_refresh').click(function(){//刷新页面
        window.location.reload();
      })

      $('#P_book').click(function(){
          $("#show_book").modal();
      })
    </script>
  </body>
</html>